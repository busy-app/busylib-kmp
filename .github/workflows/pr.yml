name: Pull request
on:
  pull_request:
    branches:
      - 'dev'
      - 'main'
      - 'prerelease/*'


# Concurrency strategy:
#   github.workflow: distinguish this workflow from others
#   github.event_name: distinguish `push` event from `pull_request` event
#   github.ref_name: distinguish branch
#   github.repository: distinguish owner+repository
#
# Reference:
#   https://docs.github.com/en/actions/using-jobs/using-concurrency
#   https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{github.ref_name}}-${{github.repository}}
  cancel-in-progress: true

jobs:
  gradle_validation:
    name: Validate gradle wrapper
    uses: ./.github/workflows/call-gradle-wrapper-validation.yml
  detekt_validation:
    name: Check by detekt
    needs: gradle_validation
    uses: ./.github/workflows/call-detekt-validation.yml
  tests_validation:
    needs: gradle_validation
    uses: ./.github/workflows/call-tests-validation.yml
  publish_internal:
    name: Publish to internal maven
    needs: gradle_validation
    uses: ./.github/workflows/call-release-internal.yml
    secrets:
      ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEY: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEY }}
      ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYID: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYID }}
      ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYPASSWORD: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYPASSWORD }}
      ORG_GRADLE_PROJECT_FLIPPERMAVEN_USERNAME: ${{ secrets.ORG_GRADLE_PROJECT_FLIPPERMAVEN_USERNAME }}
      ORG_GRADLE_PROJECT_FLIPPERMAVEN_PASSWORD: ${{ secrets.ORG_GRADLE_PROJECT_FLIPPERMAVEN_PASSWORD }}
    with:
      VERSION_NAME: pr-${{ github.event.pull_request.number }}
      VERSION_CODE: 1
      FLAVOR_TYPE: DEBUG
  post_comment:
    name: Post PR Comment about release
    runs-on: ubuntu-latest
    needs: [ publish_internal ]
    permissions:
      pull-requests: write
    steps:
      - uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## Published to Flipper Maven!
            Last commit: [${{ github.event.pull_request.head.sha }}](https://github.com/busy-app/busylib-kmp/pull/${{ github.event.pull_request.number }}/commits/${{ github.event.pull_request.head.sha }})
            
            ü§ñ Android artefact: [net.flipper.busylib.kmp:entrypoint:pr-${{ github.event.pull_request.number }}](https://reposilite.flipp.dev/#/snapshots/net/flipper/busylib/kmp/entrypoint/pr-${{ github.event.pull_request.number }})
            üçè Apple artefact: [entrypoint-xcframework-debug-pr-${{ github.event.pull_request.number }}.zip](https://reposilite.flipp.dev/snapshots/net/flipper/busylib/kmp/entrypoint-xcframework-debug/pr-${{ github.event.pull_request.number }}/entrypoint-xcframework-debug-pr-${{ github.event.pull_request.number }}.zip) (hash: `${{ needs.publish_internal.outputs.HASH_XCFRAMEWORK_DEBUG }}`)

            Version: `pr-${{ github.event.pull_request.number }}`